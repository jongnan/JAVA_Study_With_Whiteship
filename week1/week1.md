# JVM은 무엇이며 자바 코드는 어떻게 실행하는 것인가

### 목표

> 자바 소스 파일(.java)을 JVM으로 실행하는 과정 이해하자!



## JVM이란?

JVM이란, Java Virtual Machine(자바 가상 머신)의 약자로 실제 존재하는 물리적 머신이 아닌 그와 비슷하게 소프트웨어로 만든 머신이다.

그렇다면 이미 존재하는 물리적 머신 안에 또다른 가상 머신을 사용하는 것일까?  
그 답은 바로 **어느 플랫폼에도 종속적이지 않기 위함**이다.

JVM 이전의 경우, 컴파일 단계를 통해 바로 기계어로 변경되기 때문에 OS 혹은 하드웨어가 변경되었을 때 그에 맞게 변경을 해주어야 한다는 불편함이 존재했다.  
이러한 불편함을 없애기 위해 중간에서 중계자 역할이 필요해졌고 이가 바로 JVM이다.

<br>

## JVM의 구성 요소

JVM의 구성 요소는 다음 그림과 같다.

<p align="center"><img src="https://camo.githubusercontent.com/e8cafdece84756a4f7e0464861902f86c5cf65bd6496cfd8feab1ba0836cd7a9/68747470733a2f2f64322e6e617665722e636f6d2f636f6e74656e742f696d616765732f323031352f30362f68656c6c6f776f726c642d313233302d312e706e67" width=400></p>

<p align="right">출처 : <a herf="https://d2.naver.com/helloworld/1230" taget="_blank">JVM Internal - NAVER D2</a></p>

JVM은 구성 요소를 크게 3가지로 분류 할 수 있다.

### Class Loader

Java는 컴파일 타임에 클래스를 모두 로드하는 것이 아닌 런타임에 클래스를 로드하고 링크한다(동적 로드).  
이러한 동적 로드를 책임지고 있는 부분이 바로 **Class Loader**이다.

Class Loader는 몇가지 특징을 가지고 있다.

* 여러 종류의 Class Loader끼리 부모-자식 관계를 이루어 계층 구조를 생성
* 계층 구조를 이용하여 상위 로더에 위임이 가능(하위 로더로의 위임은 불가능)
  즉, 하위 로더에서 클래스를 찾고 없다면 상위 로더로 위임하는 형태
* 클래스의 언로드는 불가능

### Runtime Data Areas

<p align="center"><img src="https://camo.githubusercontent.com/ef7b4cfa8b297aafb6d019e1a3bab77c9fabebd9f72283259b651e6309ece779/68747470733a2f2f64322e6e617665722e636f6d2f636f6e74656e742f696d616765732f323031352f30362f68656c6c6f776f726c642d313233302d342e706e67" width=400></p>

<p align="right">출처 : <a herf="https://d2.naver.com/helloworld/1230" taget="_blank">JVM Internal - NAVER D2</a></p>

런타임 데이터 영역은 JVM이 실행되면서 할당받은 메모리 영역이다.  
위 그림과 같이 크게 6개의 영역으로 나뉠 수 있는데, 각 영역의 라이프 사이클이 다르다.  
`PC Register`, `JVM Stack`, `Native Method Stack` 의  경우 생성된 스레드와 함께 생성되고 소멸한다.  
나머지는 Class와 JVM의 생명주기를 따른다.

* PC Register

  > 스레드가 어떤 명령을 실행할 것인지에 대한 명령 주소를 가지고 있다.

* JVM Stack

  > 스택 프레임이라는 구조체를 저장하는 공간으로, 스택 프레임은 메소드가 실행될 때 생성되어 JVM Stack에 쌓이고, 종료되면 JVM Stack에서 빠져나간다. 

* Native Method Stack

  > 자바 이외의 언어로 작성된 네이티브 코드를 위한 스택으로 자바로 직접 제어하지 못하는 기능을 수행할 때 사용된다.

* Heap

  > 인스턴스 또는 객체를 저장하는 공간으로 Garbage Collection에 의해 관리되는 공간이다.  
  > JVM의 성능에 가장 영향이 미치며 JVM마다 힙의 구성과 GC의 방식이 다르다.

* Method Area

  > 클래스와 인터페이스의 대한 정보들을 보관하는 공간이다.
  > (Hotspot JVM - Metaspace)

* Runtime Constant Pool

  > 각 클래스와 인터페이스의 상수와 메소드, 필드에 대한 모든 레퍼런스까지 담고 있는 테이블이다.  
  > 이 런타임 상수 풀을 통해 실제 메모리 주소를 찾아 참조하기에 JVM에서도 핵심적인 역할을 하는 공간이다.

### Execution Engine

런타임 데이터 영역에 배치되어있는 바이트코드를 명령어 단위로 읽어 실행하는 역할을 맡고있다.  
실행하는 방식으로는 **인터프리터**와  **JIT(Just-In-Time) 컴파일러** 방식이 존재한다.

<br>

## 바이트코드란 무엇인가?

JVM에서 인식할 수 있는 코드로 개발자가 작성한 코드와 기계어 사이에 존재하는 중간 단계 언어이다.  
바이트코드의 존재 의미는 JVM과 동일하게 "**종속성**"에 있다.  
즉, 여러 플랫폼에 종속적이지 않는 머신과 그 머신이 동작할 수 있는 언어를 만든다면 하나하나 만드는 것보다 더 높은 효율성을 가질 수 있기에 가상 머신과 중간 단계 언어를 사용하는 것이다.

<br>

## JIT 컴파일러란 무엇이며 어떻게 동작하는가?

JIT는 Just-In-Time의 약어로 인터프리터 방식의 단점을 보완하기 위해 도입되었다.  
인터프리터 방식을 사용하다 적절한 시점에서 바이트코드들을 한번에 기계어로 변경하여 실행한다.  
이후 해당 메소드나 코드의 일부분을 만난다면 인터프리터 방식을 사용하는 것이 아닌 기계어로 번역된 코드를 사용하여 빠르게 실행한다.  
어떻게 보면 JIT 컴파일러만 사용하는 것이 유리해 보이지만, 몇번 사용되지 않는 코드의 경우에는 기계어로 컴파일 하는 시간이 더욱 오래 걸리기에 인터프리터를 사용하는 것이 더욱 좋다.  

#### HotSpot VM

많이 사용되는 오라클의 HotSpot VM은 Hotspot 컴파일러란 JIT 컴파일러를 사용한다.  
Hotspot 컴파일러는 내부적인 알고리즘에 의해 컴파일이 필요한 부분을 찾고 이를 기계어로 컴파일한다.  
기계어로 바뀐 곳도 자주 불리지 않는다면 해당 캐시를 지우고 다시 인터프리터 방식으로 실행한다.

<br>

## 컴파일 하는 방법

컴파일은 [Window - cmd], [Mac - terminal]에서 `javac` 명령어를 통해 컴파일한다.  
해당 명령어는 JDK(Java Development Kit)을 설치하고 환경 변수 셋팅이 되어있어야 어디서든 실행이 가능하다.

컴파일 방법

1. 컴파일 할 java 파일이 존재하는 폴더로 이동
2. `javac` 명령어와 컴파일할 파일의 이름을 작성
3. 에러가 나지 않는다면 바로 `.class` 파일(바이트코드)이 생성
4. 에러시 에러 로그를 표시

<br>

## 실행하는 방법

컴파일한 `.class` 파일 위치에서 `java` 명령어를 통해 실행한다.  
여기서 주의할 점은 중간에 패키지가 존재할 경우, 해당 위치에서 실행하면 `오류: 기본 클래스 Main을(를) 찾거나 로드할 수 없습니다.` 라는 에러를 발견할 수 있다.  
이 같이 나오는 이유는 `java` 명령어에 실행할 파일 이름을 인자로 줄 때, 기본적으로 인식하는 위치가 최상위 폴더이기 때문이다.  
즉, `src` 위치에서 해당 파일을 찾기 때문에 패키지 안에 존재하는 파일은 찾지 못한다.  
따라서 패키지 안에 있는 바이트코드를 실행시 패키지 이름을 포함한 경로를 적어주어야 한다.

실행 방법

1. 컴파일 된 `.class` 파일이 존재하는 폴더로 이동
2. `java` 명령어와 실행할 파일의 이름을 작성  
   만약, 패키지가 존재할 경우 패키지 이름을 포함한 경로까지 작성  
   `java Main` → X , `java com/jongnan/Main` → O

<br>

## JDK와 JRE의 차이

<p align="center"><img src="image/java_tot_env.png" width=500></p>

#### JDK(Java Development Kit)

자바를 개발할 때 사용되는 도구들의 모음으로 컴파일러, 역어셈블러, 디버거 등을 제공한다.

#### JRE(Java Runtime Environment)

자바로 만들어진 프로그램을 실행하기 위해 기본 라이브러리와 클래스 로더등을 제공한다.

<br>

---

### Reference

* [NAVER D2 - JVM Internal](https://d2.naver.com/helloworld/1230)
* [JAVA ) 오류: 기본 클래스 ...을(를) 찾거나 로드할 수 없습니다.](https://zeddios.tistory.com/41)
* [Back to the Essence - Java 컴파일에서 실행까지](https://homoefficio.github.io/2019/01/31/Back-to-the-Essence-Java-%EC%BB%B4%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%EC%8B%A4%ED%96%89%EA%B9%8C%EC%A7%80-1/)